<!DOCTYPE html><html domain=thefortunedays.com lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=735479e2c4" rel=icon type=image/png><meta content=#ff577d name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Go Map Hash</title><meta content="Go Map Hash" property=og:title><meta content="How to implement hash function in Go." name=description><meta content="How to implement hash function in Go." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@phamthethanh108 name=twitter:site><meta content=@phamthethanh108 name=twitter:creator><meta content=https://thefortunedays.com/img/remote/Z1o6V9l.jpg property=og:image><link href=https://thefortunedays.com/articles/go-map-hash/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="The Fortune Days"><link href=/ rel=preconnect crossorigin=""><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Coustard:wght@400;900&family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&family=UnifrakturMaguntia&display=swap" rel=stylesheet><script async src="/js/min.js?hash=8db32dcb3a" data-cwv-src="/js/web-vitals.js?hash=a2ed2205a4" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-9X9G2YCR2X"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-9X9G2YCR2X');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>@keyframes neon-blink{44%,46%,98%,to{opacity:1}45%{opacity:.7}99%{opacity:.5}}:root{--primary: black;--primary-dark: black;--text-color: black;--bg-color: white;--nav-bg-color: #fff;--nav-text-color: black;--reading-progress: lightgray;--footer-bg-color: white;--footer-text-color: black;--code-bg: #e2777a;--code: #2d2d2d;--mark: #f9c412;--hr: black;--figcaption: #ccc;--heading-color: black;--post-date: rgb(56, 54, 54);--post-separator: rgb(56, 54, 54);--font-family: 'Lora', sans-serif;--main-width: calc(100vw - 3em)
}main img{content-visibility:auto}article *{scroll-margin-top:50px}header{z-index:1;display:flex;flex-direction:column;align-items:center;padding-top:2em;padding-bottom:2em}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)
  }}html{line-height:1.15;-webkit-text-size-adjust:100%;font-size:14px;color:var(--text-color);background-color:var(--bg-color);text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}body{margin:0}@media (min-width:320px){html{font-size:14px}}@media (min-width:480px){html{font-size:14px}}@media (min-width:600px){html{font-size:14px}}@media (min-width:801px){html{font-size:14px}}@media (min-width:1025px){html{font-size:16px}}@media (min-width:1281px){html{font-size:16px}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}.apple share-widget div{background-image:url(/img/share-apple.svg)}dialog{background-color:#0a9cf5;z-index:1000;border:.2rem solid #fff;border-radius:1.25rem;padding:1.25em}img[align=left]{width:auto;height:16rem;margin-right:1rem;margin-bottom:1rem}dl{clear:both;display:block!important;margin:0 0 1.5em}#posts li{margin-bottom:.5em}hr{box-sizing:content-box;height:0;overflow:visible;border-bottom:1px solid var(--hr)}pre,samp{font-size:1em}samp{font-family:monospace,monospace}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}abbr[title]{border-bottom:0;text-decoration:underline dotted}b,strong{font-weight:700}small{font-size:80%;color:#ccc}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15}input,optgroup,select,textarea{margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}legend{color:inherit;display:table;max-width:100%;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}h1,h2,h3,h4,h5{margin:3rem 0 1.38rem;line-height:1.3;font-weight:400}h1{font-size:2.074rem}h2{font-size:1.728rem}h3{font-size:1.44rem}h4{font-size:1.2rem}h5{font-size:1rem}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}dt,th{font-weight:600}td,th{border-bottom:1px solid #595959;overflow:auto;padding:.75em;text-align:left;vertical-align:top}thead th{border-bottom:1px solid #f9c412}table{display:table}code,pre,table{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}code,kbd,mark{padding:0 .3em}code,kbd{border-radius:.3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:var(--code-bg);color:var(--code)}mark{background:var(--mark)}h1,h2{font-family:"Coustard"}a:hover{text-decoration:underline}figcaption{color:var(--figcaption);margin-top:.75em;font-size:80%}@media (max-width:767px){fieldset{min-width:0}fieldset *{flex-grow:1;page-break-before:auto}x:-moz-any-link{display:table-cell}}html{font-family:var(--font-family)}form{padding:1.5em 1.5em 0;border:.2rem solid #202020}form small{font-style:italic}fieldset{padding:0;margin:0}fieldset legend{font-size:150%;margin-bottom:.75em}button,input,select,textarea{border-radius:.3em;max-width:100%}input{padding:.75em}textarea{display:inline-block}button+input[type=checkbox],button+input[type=radio],button+label,input+input[type=checkbox],input+input[type=radio],input+label,label+*,select+input[type=checkbox],select+input[type=radio],select+label,textarea+input[type=checkbox],textarea+input[type=radio],textarea+label{page-break-before:always}form,input,select,textarea{margin-bottom:1.5em}textarea{min-height:7.5em;min-width:15em}label{display:inline-block}fieldset>*,figure img{display:block}input,select{display:inline}fieldset>*,form>:not(fieldset){margin-right:.75em}button,input[type=reset],input[type=submit]{background:var(--primary);color:var(--text-color);cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover,input[type=reset]:hover,input[type=submit]:hover{background:var(--primary-dark);color:var(--text-color)}button[disabled],input[type=reset][disabled],input[type=submit][disabled]{background:#e6e6e6;color:#404040;cursor:not-allowed}button:not([disabled]),button[type=submit],input[type=submit]{background:#f9c412;color:#181818}button:not([disabled]):hover,button[type=submit]:hover,input[type=submit]:hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=color],input[type=date],input[type=datetime-local],input[type=datetime],input[type=email],input[type=file],input[type=month],input[type=number],input[type=password],input[type=phone],input[type=range],input[type=search],input[type=tel],input[type=text],input[type=time],input[type=url],input[type=week],select,textarea{border:1px solid #595959;padding:.75em}input[type=checkbox],input[type=radio]{flex-grow:0;margin:.75em .375em .75em 0;vertical-align:middle}input[type=checkbox]+label,input[type=radio]+label{page-break-before:avoid}select[multiple]{min-width:15em}*{border:0;box-sizing:border-box}article,img,video{max-width:100%;margin:0 auto}img,video{height:auto}body{font-family:var(--font-family);background:var(--bg-color);color:var(--text-color)}section{margin-left:auto;margin-right:auto;width:900px}main{max-width:70rem;margin:0 auto}footer{background:var(--footer-bg-color);padding:1em;text-align:center;border-top:.5px solid #d3d3d3}footer,footer a{color:var(--footer-text-color)}footer>*{font-family:'Oswald'}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{padding:0 1.5em 4.5em;width:45.5em;min-height:100vh}ol,ul{margin-top:0}li dl,li ol,li ul{margin-bottom:0}dt{padding-top:.75em;padding-left:.75em}dd{padding-bottom:.75em;margin-left:2.25em}dd+dt{border-top:1px solid #f9c412;border-top:1px solid var(--primary)}blockquote{border-left:1px solid #f9c412;padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:3px solid var(--primary)}blockquote footer{background:0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}figure,footer>*{margin:1.5em}code[class*=language-],pre[class*=language-]{color:#ccc;background:0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}button:not([disabled]),button[type=submit],input[type=submit]{background:var(--primary)}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.about{min-height:80vh}.about h1,.tags-list h1{font-family:'Coustard';padding-bottom:1em}.tags-list{text-align:center}.tags,.tags-list{min-height:80vh}.tags h1,article h1{text-align:center;padding-bottom:1em}.tags h1,article h1,article h2,h3,h4,h5,h6{font-family:'Coustard'}@media (min-width:600px){.about{min-height:calc(100vh - 360px)}.tags-list{text-align:center}.tags,.tags-list{min-height:calc(100vh - 360px)}}.home .banner{width:100%;margin-bottom:3em;opacity:90%}.post{margin-bottom:30px}.post .title,article h1,article h2,h3,h4,h5,h6{color:var(--heading-color)}.post .title{font-family:"Coustard";font-size:1.125em}.post .title .draft{color:#b8860b}.post .date,.post .description{margin-top:5px;color:var(--text-color)}.post .date{font-size:.75em;color:var(--post-date);text-transform:uppercase}.post .separator{color:var(--post-separator);opacity:.1}blockquote>p{font-size:1.5rem;font-style:italic}blockquote p:last-child{font-size:1.2rem;font-weight:400}header div{padding-bottom:4em}.pagetitle{font-family:"UnifrakturMaguntia";font-size:3em;font-weight:900}.menu,.pagetitle,.pagetitle:hover{text-decoration:none}nav{width:100%}#nav{max-width:45.5em;margin:0 auto;padding:.5em;display:flex;justify-content:center;gap:5px;border-top:1px solid #d3d3d3;border-bottom:1px solid #d3d3d3}.menu{padding:5px 10px;font-family:"Coustard"}share-widget div{width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;color:gray}share-widget button{margin:0;background-color:#a9a9a9!important}share-widget button:hover{background-color:#ecbb19!important}share-widget button:active{transform:scale(1.2)}</style><header><div><a href=/ class=pagetitle title=Homepage>The Fortune Days</a></div><nav><div id=nav><a href=/ class=menu>Home</a> <a href=/tags/ai class=menu>AI</a> <a href=/tags/not-ai class=menu>Not AI</a> <a href=/tags/ class=menu>Tags</a> <a href=/about/ class=menu>About</a></div></nav><dialog id=message></dialog></header><main><article><h1>Go Map Hash</h1><h2 id=maphash>maphash <a href=#maphash class=direct-link>#</a></h2><p>Map implementation is one of the interesting features in Go, it accepts anything as key, from string to numbers or even complex structs. And the magic thing is it is able to calculate the hash code of the given key effectively without the need to provide any hash code function. I feel this is really interesting and it stimulates my curiosity every single time I use map.<p>I would like to know how it's implemented and whether I can use the same implementation for some other contexts. But unfortunately, Go doesn't expose the hash code implementation for us to use directly. If you have enough knowledge about Go compiler and Go runtime you still can investigate and copy the implementation. I actually tried but found it's quite challenging and requires a lot of effort. It requires a lot of understanding about the compiler and runtime and also requires understanding of assembly code - which I feel is a little bit scary [1].<p>Luckily, Go have another package that helps to simplify the implementation of hash code for map. It is the package <code>maphash</code>. With the <code>maphash</code> package, we can easily implement the hash code the primitive types like string or numbers:<pre class=language-go><code class=language-go><span class="token keyword">var</span> h maphash<span class="token punctuation">.</span>Hash<br>h<span class="token punctuation">.</span><span class="token function">SetSeed</span><span class="token punctuation">(</span>maphash<span class="token punctuation">.</span><span class="token function">MakeSeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>h<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><br>hashCode <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 10811116414953202048</span></code></pre><p><a href=https://go.dev/play/p/08MZh66HNxJ>Playground</a><pre class=language-css><code class=language-css><span class="token property">number</span> <span class="token punctuation">:</span>= 12.3<br>var h maphash.Hash<br>h.<span class="token function">SetSeed</span><span class="token punctuation">(</span>maphash.<span class="token function">MakeSeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>binary.<span class="token function">Write</span><span class="token punctuation">(</span>&h<span class="token punctuation">,</span> binary.BigEndian<span class="token punctuation">,</span> number<span class="token punctuation">)</span><br><span class="token property">hashCode</span> <span class="token punctuation">:</span>= h.<span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> // 4236663090134902550</code></pre><p><a href=https://go.dev/play/p/2YSIZsOWhio>Playground</a><p>But what if we have a key of the map is a struct that includes fields of different types like below:<pre class=language-go><code class=language-go><span class="token keyword">type</span> Employee <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	Name      <span class="token builtin">string</span><br>	Age       <span class="token builtin">int</span><br>	Address   <span class="token builtin">string</span><br>	BirthDate time<span class="token punctuation">.</span>Time<br><span class="token punctuation">}</span></code></pre><p>How can we implement the hash code? You might think that we just need to convert everything into string and contact them together to form a key? But it will cause some problems, the 2 following employees will have the same key and hence the same hash code:<pre class=language-go><code class=language-go>e1 <span class="token operator">:=</span> Employee<span class="token punctuation">{</span><br>	Name<span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span><br>	Age<span class="token punctuation">:</span>  <span class="token number">15</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><span class="token comment">// Key: Jack15</span><br><br>e2 <span class="token operator">:=</span> Employee<span class="token punctuation">{</span><br>	Name<span class="token punctuation">:</span> <span class="token string">"Jack1"</span><span class="token punctuation">,</span><br>	Age<span class="token punctuation">:</span>  <span class="token number">5</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><span class="token comment">// Key: Jack15</span></code></pre><p><a href=https://go.dev/play/p/Ul9X8P6XmkJ>Playground</a><p>You can argue that we can add a separator between the fields... but then we need to identify which ones are safe to use. And if the separator collides with the value of the key?<p>Because of those complexities, we need another simple mechanism to apply. But unfortunately there is no guideline from Go on how to implement the hash code. Hence the best way I can imagine is to use the similar mechanism that I used to use while working with Java. This mechanism uses 2 primes numbers, one as the init of the hash code and another one as a multiply factor for the hash code. It is quite popular in the Java community. The steps can be described as below:<ol><li>Let call the hash code we want to calculate is <code>sum</code><li>Init <code>sum</code> with value is a prime number. i.e. 7: <code>sum = 7</code><li>For every single field <code>n</code> of the given struct, calculate its hash code <code>sum_n</code>.<ol><li>If type of the field is kind of byte or string, write directly to the <code>maphash.Hash</code><li>If type of the field is boolean, number, or slice values of them, use <code>binary.Write</code> to write to the <code>maphash.Hash</code><li>If it's time, get its binary value by calling <code>MarshalBinary()</code> and write to the <code>maphash.Hash</code>. Or you can simply get the <code>UnixNano()</code> and uses <code>binary.Write</code> for it.<li>If you have a slice or map of types, iterate over it and apply the same principle to calculate its sum.</ol><li>Combine the <code>sum_n</code> with the total sum by multiple it with the multiply factor (which is also another prime number), i.e 31: <code>sum = sum * 31 + sum_n</code><li>Perform step #3 and #4 for all the fields of the struct that should be used for comparing the struct.</ol><p>Applying the above rules, we can have the hash code for the struct <code>Employee</code> as below:<pre class=language-go><code class=language-go><span class="token keyword">var</span> seed <span class="token operator">=</span> maphash<span class="token punctuation">.</span><span class="token function">MakeSeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">hashEmployee</span><span class="token punctuation">(</span>e Employee<span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> h maphash<span class="token punctuation">.</span>Hash<br>	h<span class="token punctuation">.</span><span class="token function">SetSeed</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span><br>	sum <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><br><br>	h<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><br>	sum <span class="token operator">=</span> sum<span class="token operator">*</span><span class="token number">31</span> <span class="token operator">+</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	h<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token operator">&</span>h<span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Age<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	sum <span class="token operator">=</span> sum<span class="token operator">*</span><span class="token number">31</span> <span class="token operator">+</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	h<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	h<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><br>	sum <span class="token operator">=</span> sum<span class="token operator">*</span><span class="token number">31</span> <span class="token operator">+</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	h<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> e<span class="token punctuation">.</span>BirthDate<span class="token punctuation">.</span><span class="token function">MarshalBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><br>	sum <span class="token operator">=</span> sum<span class="token operator">*</span><span class="token number">31</span> <span class="token operator">+</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> sum<br><span class="token punctuation">}</span><br><br><span class="token function">hashEmployee</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span> <span class="token comment">// 4034376227000349563</span><br><span class="token function">hashEmployee</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span> <span class="token comment">// 9233382178721626727</span></code></pre><p><a href=https://go.dev/play/p/nj0IPwvY3lw>Playground</a><p>I think this mechanism is quite easy to use and its performance is acceptable for production code.<h2 id=unsafe-hack>Unsafe Hack <a href=#unsafe-hack class=direct-link>#</a></h2><p>If you are not happy with the performance of the above hash mechanism and still want to use the Go internal hash implementation, below is an unsafe hack that you might want to consider:<pre class=language-go><code class=language-go><span class="token keyword">func</span> UnsafeHashOf<span class="token punctuation">[</span>T comparable<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>seed maphash<span class="token punctuation">.</span>Seed<span class="token punctuation">,</span> v T<span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span><br>	h <span class="token operator">:=</span> getHashFunc<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>seed maphash<span class="token punctuation">.</span>Seed<span class="token punctuation">,</span> v T<span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span>seed<span class="token punctuation">,</span> v<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// internal/abi/type.go -> Type</span><br><span class="token keyword">type</span> abiType <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	Size_       <span class="token builtin">uintptr</span><br>	PtrBytes    <span class="token builtin">uintptr</span> <span class="token comment">// number of (prefix) bytes in the type that can contain pointers</span><br>	Hash        <span class="token builtin">uint32</span>  <span class="token comment">// hash of type; avoids computation in hash tables</span><br>	TFlag       <span class="token builtin">uint8</span>   <span class="token comment">// extra type information flags</span><br>	Align_      <span class="token builtin">uint8</span>   <span class="token comment">// alignment of variable with this type</span><br>	FieldAlign_ <span class="token builtin">uint8</span>   <span class="token comment">// alignment of struct field with this type</span><br>	Kind_       <span class="token builtin">uint8</span>   <span class="token comment">// enumeration for C</span><br>	<span class="token comment">// function for comparing objects of this type</span><br>	<span class="token comment">// (ptr to object A, ptr to object B) -> ==?</span><br>	Equal <span class="token keyword">func</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span><br>	<span class="token comment">// GCData stores the GC type data for the garbage collector.</span><br>	<span class="token comment">// If the KindGCProg bit is set in kind, GCData is a GC program.</span><br>	<span class="token comment">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span><br>	GCData    <span class="token operator">*</span><span class="token builtin">byte</span><br>	Str       <span class="token builtin">int32</span> <span class="token comment">// string form</span><br>	PtrToThis <span class="token builtin">int32</span> <span class="token comment">// type for pointer to this type, may be zero</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// internal/abi/type.go -> MapType</span><br><span class="token keyword">type</span> abiMapType<span class="token punctuation">[</span>T comparable<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	abiType<br>	Key    <span class="token operator">*</span>abiType<br>	Elem   <span class="token operator">*</span>abiType<br>	Bucket <span class="token operator">*</span>abiType <span class="token comment">// internal type representing a hash bucket</span><br>	<span class="token comment">// function for hashing keys (ptr to key, seed) -> hash</span><br>	Hasher     hashFunc<span class="token punctuation">[</span>T<span class="token punctuation">]</span><br>	KeySize    <span class="token builtin">uint8</span>  <span class="token comment">// size of key slot</span><br>	ValueSize  <span class="token builtin">uint8</span>  <span class="token comment">// size of elem slot</span><br>	BucketSize <span class="token builtin">uint16</span> <span class="token comment">// size of bucket</span><br>	Flags      <span class="token builtin">uint32</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> hashFunc<span class="token punctuation">[</span>T comparable<span class="token punctuation">]</span> <span class="token keyword">func</span><span class="token punctuation">(</span>value <span class="token operator">*</span>T<span class="token punctuation">,</span> seed maphash<span class="token punctuation">.</span>Seed<span class="token punctuation">)</span> <span class="token builtin">uintptr</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>h hashFunc<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Sum64</span><span class="token punctuation">(</span>seed maphash<span class="token punctuation">.</span>Seed<span class="token punctuation">,</span> v T<span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token operator">&</span>v<span class="token punctuation">,</span> seed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br><br><span class="token keyword">type</span> emptyInterface <span class="token keyword">struct</span><span class="token punctuation">{</span> typ <span class="token operator">*</span>abiType <span class="token punctuation">}</span><br><br><span class="token keyword">func</span> getHashFunc<span class="token punctuation">[</span>T comparable<span class="token punctuation">]</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> hashFunc<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>abiMapType<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>emptyInterface<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>typ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Hasher<br><span class="token punctuation">}</span></code></pre><p><a href=https://go.dev/play/p/KamuMXsaIHD>Playground</a><p>Please note that the above hack is not safe and will be broken if Go change its internal types.<h2 id=performance>Performance <a href=#performance class=direct-link>#</a></h2><p>Performance of using maphash is much worse compared to the hack method but it's safe to use. Hence you can base on your use-case to decide which one is suitable.<pre class=language-bash><code class=language-bash>goos: linux<br>goarch: amd64<br>pkg: github.com/pthethanh/cache<br>cpu: 12th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-1255U<br>BenchmarkMapHashNormal-12        <span class="token number">9833695</span>               <span class="token number">110.4</span> ns/op           <span class="token number">184</span> B/op          <span class="token number">3</span> allocs/op<br>BenchmarkMapHashHack-12         <span class="token number">29772643</span>                <span class="token number">38.80</span> ns/op           <span class="token number">64</span> B/op          <span class="token number">1</span> allocs/op<br>PASS<br>ok      github.com/pthethanh/cache      <span class="token number">2</span>.411s</code></pre><p><a href=https://go.dev/play/p/CTftjsDPNld>Playground</a><hr><p>[1] You can take a look at the implementation of map in Go at <a href=https://github.com/golang/go/blob/master/src/runtime/map.go>map.go</a>, <a href=https://github.com/golang/go/blob/master/src/runtime/map_fast32.go>map_fast32.go</a>, <a href=https://github.com/golang/go/blob/master/src/runtime/map_fast64.go>map_fast64.go</a>, <a href=https://github.com/golang/go/blob/master/src/runtime/map_faststr.go>map_faststr.go</a>, <a href=https://github.com/golang/go/blob/master/src/runtime/alg.go>alg.go</a> and some relevant assembly code files can be found in the same run time package.</p><share-widget><button aria-label=Share href=https://thefortunedays.com/articles/go-map-hash/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Go Map Hash",
  "image": [],
  "author": "Thanh", 
  "genre": "Blog", 
  "publisher": {
    "@type": "Organization",
    "name": "Thanh",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=735479e2c4"
    }
  },
  "url": "https://thefortunedays.com/articles/go-map-hash/",
  "mainEntityOfPage": "https://thefortunedays.com/articles/go-map-hash/",
  "datePublished": "2023-06-10",
  "dateModified": "2025-06-24",
  "description": "maphash # Map implementation is one of the interesting features in Go, it accepts anything as key, from string to numbers or even complex..."
}</script></article></main><footer><a href=/about/ >Thanh</a></footer>