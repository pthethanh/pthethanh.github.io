<!DOCTYPE html><html domain=thefortunedays.com lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=735479e2c4" rel=icon type=image/png><meta content=#ff577d name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Measure Execution Time</title><meta content="Measure Execution Time" property=og:title><meta content="Summary: Measuring time is a very important step to optimize performance or identify a performance issue. This article shows you how easy..." name=description><meta content="Summary: Measuring time is a very important step to optimize performance or identify a performance issue. This article shows you how easy..." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@phamthethanh108 name=twitter:site><meta content=@phamthethanh108 name=twitter:creator><meta content=https://thefortunedays.com/img/remote/Z1o6V9l.jpg property=og:image><link href=https://thefortunedays.com/articles/measure-execution-time/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="The Fortune Days"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/CyberwayRiders.woff2 rel=preload type=font/woff2 as=font crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async src="/js/min.js?hash=8db32dcb3a" data-cwv-src="/js/web-vitals.js?hash=4a3c7b61e1" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-9X9G2YCR2X"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9X9G2YCR2X');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #ff577d;--primary-dark:#ff184c;--text-color: #F5F5F7;--bg-color: 	#003062;--nav-bg-color: #ff577d;--nav-text-color: #fff;--footer-bg-color: #091833;--footer-text-color: #999;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.575em 1.5em;background:var(--nav-bg-color);color:var(--nav-text-color);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#0a9cf5;z-index:1000}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"CyberwayRiders";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/CyberwayRiders.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Inter UI",sans-serif;--font-family: "Inter UI", sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}body,p,pre{font-size:1em}p,pre{margin-bottom:1.5em}h1,h2{line-height:2.4rem;margin-bottom:1.36rem}h2{font-size:1.728rem}body,p,pre{font-size:1rem;line-height:1.6}p,pre{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}body,p,pre{font-size:1.1rem;line-height:1.6}h1,h2,p,pre{margin-bottom:1.496rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2{font-family:var(--font-family)}h2{font-style:italic}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:var(--bg-color);color:var(--text-color)}header{padding:4em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:var(--nav-text-color);margin-left:1.5em;font-family:'CyberwayRiders';text-shadow:0 0 7px #fff,0 0 42px #0a9cf5}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto}footer{background:var(--footer-bg-color);color:var(--footer-text-color);padding:3em;text-align:center}footer>*{margin:1.5em;font-family:'CyberwayRiders';text-shadow:0 0 7px #fff,0 0 42px #0a9cf5}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.function{color:#f08d49}.token.property{color:#f8c555}.token.builtin,.token.important,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.important{font-weight:700}.token.inserted{color:green}.about,.tags{min-height:80vh}.about h1{padding-bottom:1em}article h1{text-align:center;text-shadow:0 0 7px #fff,0 0 42px #0a9cf5}article aside{font-style:italic;text-align:center;padding-bottom:4.25em}.about h1,.tags h1,article h1,h2{font-family:'CyberwayRiders'}.tags h1{padding-bottom:1em;text-align:center}h2{text-shadow:0 0 7px #fff,0 0 42px #0a9cf5}@media (min-width:600px){.about,.tags{min-height:calc(100vh - 360px)}}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>The Fortune Days</a></h1><a href=/tags/ >Tags</a> <a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><dialog id=message></dialog></header><main><article><h1>Measure Execution Time</h1><aside>5 min read.</aside><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vx8xA-1920w.avif 1920w, /img/remote/vx8xA-1280w.avif 1280w, /img/remote/vx8xA-640w.avif 640w, /img/remote/vx8xA-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vx8xA-1920w.webp 1920w, /img/remote/vx8xA-1280w.webp 1280w, /img/remote/vx8xA-640w.webp 640w, /img/remote/vx8xA-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vx8xA-1920w.jpg 1920w, /img/remote/vx8xA-1280w.jpg 1280w, /img/remote/vx8xA-640w.jpg 640w, /img/remote/vx8xA-320w.jpg 320w" type=image/jpeg><img alt="Malvestida Magazine/Unsplash" decoding=async height=1707 loading=lazy src=/img/remote/vx8xA-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2560 1707'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAs0lEQVQImQGoAFf/ACTV2jrZ3z7d4Urf41Lg41Hg5FHg5FPf40Ha3QAe1t0r2eE63uSWsKm3oZdpzM0/4+lJ3eJA298AFtXcENjiXc/M5XBh8Ek7qKuhNuPoNtngMNjfAA3Q1wHW30vIw7+Le718c5qypCfd4x3Y3xXV3AAEy9IA0dlPvrVMzskP3+l2wbUZ1dcC1doF0dcAA7zCAMbQaKqbP8C7AMnTdbCfIMjIAMzTAsPIhq5i6SD0UMUAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" width=2560></picture><p><strong>Summary</strong>: Measuring time is a very important step to optimize performance or identify a performance issue. This article shows you how easy implementing it in Go.<p>In Go, the simplest way to measure execution time is using the combination of <code>time.Now()</code> and <code>time.Since()</code>. <code>time.Now()</code>records the current time and <code>time.Since()</code> calculates the total time since a specific time.<p>For measure execution time of a block of code, we just need to do:<pre class=language-go><code class=language-go>t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token comment">// Do something</span><br>d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span></code></pre><p>If we want to measure the execution time of the whole function, the simplest way is to wrap it with a <code>defer</code>:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><br>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Execution time: %v\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token comment">// Do something</span><br><span class="token punctuation">}</span></code></pre><p>The above block of code is even better if we break the time measurement logic into a utilities function so that it can be reused across our code base:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">measureTime</span><span class="token punctuation">(</span>context <span class="token builtin">string</span><span class="token punctuation">,</span> t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><br>	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Execution time of %s: %v\n"</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> d<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">defer</span> <span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doSomething"</span><span class="token punctuation">,</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token comment">// Do something</span><br><span class="token punctuation">}</span></code></pre><h2 id=multiple-steps>Multiple Steps <a href=#multiple-steps class=direct-link>#</a></h2><p>In reality, our function or block of code may have multiple steps inside and we may want to measure their performance. The code can be run consecutively or concurrently. But let consider the below function which has multiple execution steps run consecutively first:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>The execution flow would looks like this:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/10ttJe-1920w.avif 1920w, /img/remote/10ttJe-1280w.avif 1280w, /img/remote/10ttJe-640w.avif 640w, /img/remote/10ttJe-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/10ttJe-1920w.webp 1920w, /img/remote/10ttJe-1280w.webp 1280w, /img/remote/10ttJe-640w.webp 640w, /img/remote/10ttJe-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/10ttJe-1920w.jpg 1920w, /img/remote/10ttJe-1280w.jpg 1280w, /img/remote/10ttJe-640w.jpg 640w, /img/remote/10ttJe-320w.jpg 320w" type=image/jpeg><img alt="Execution Flow/Thanh Pham" decoding=async height=160 loading=lazy src=/img/remote/10ttJe-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 320 160'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAoklEQVQImWO4O7tg7tP+wO0zSy0ze7O0M7rT1NPLQ8QzWpOUUytCxbJb4uUyykNE04vDVaMZLhaWLL8aE3deXUaanYEYICYtxa26p/u0yprmUxpbu864TKnMwamYnZ2d2TDe318rzj9AO84/qK5rUXJZ4MyMkqCZmemuXbllgTNTo+wLfbFqnlK5PnlT5Zv1q8sfrl5acXPjpso3q7e2PZ4IAOWOPRROV1jAAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=320></picture><p>Execution Flow/Thanh Pham<p>Apply the same principle as our very first example, the time measurement code would look like this:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doSomething"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep1"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><br>	t <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep2"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><br>	t <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep3"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p><a href=https://play.golang.org/p/xBVzw4z1C2b>Code</a><h2 id=concurrency>Concurrency <a href=#concurrency class=direct-link>#</a></h2><p>What if our code uses goroutine? Consider the below function where <code>doStep2</code> runs inside a goroutine:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>We can see that after <code>doStep1</code> , <code>doStep2</code>and <code>doStep3</code> will run concurrently. The execution flow would look like:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZDcrhv-1920w.avif 1920w, /img/remote/ZDcrhv-1280w.avif 1280w, /img/remote/ZDcrhv-640w.avif 640w, /img/remote/ZDcrhv-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZDcrhv-1920w.webp 1920w, /img/remote/ZDcrhv-1280w.webp 1280w, /img/remote/ZDcrhv-640w.webp 640w, /img/remote/ZDcrhv-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZDcrhv-1920w.jpg 1920w, /img/remote/ZDcrhv-1280w.jpg 1280w, /img/remote/ZDcrhv-640w.jpg 640w, /img/remote/ZDcrhv-320w.jpg 320w" type=image/jpeg><img alt="Concurrent Execution Flow/Thanh Pham" decoding=async height=154 loading=lazy src=/img/remote/ZDcrhv-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 320 154'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAA3UlEQVQImWN4siF8+puVplvfrDTdeH2e7e4bC2x2Xp9nu/PGAqsdNxbY7H693Gz56xUmm5+tC5rFcKelYOaVkphDjxoSN3maSxu7GwubupkIG7gZCRm5mwgau5mI6ruZiBo5mchqMNT7+vk1urhEdyfEZTs0ZsfZ1WfG29VlJ9rWZSRaVafGicnLCDGgAyVdPeXwFWt3Ri5fuztq/oq9IatX7otYs3ZXaFBegJNhiLGzaaA2XLG2ionSwvh7G+fF3103L/722knxJ3fPTbi5Y1HyvW2Lku/tWFJ6fTYACRdZssJHrVgAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" width=320></picture><p>Concurrent Execution Flow/Thanh Pham<p>Base on the execution flow, <code>doStep2</code>and <code>doStep3</code>start at the same time (almost). Hence we can do this:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doSomething"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep1"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><br>	t <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep2"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">measureTime</span><span class="token punctuation">(</span><span class="token string">"doStep3"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p><a href=https://play.golang.org/p/y-cJRQR2fEj>Code</a><h2 id=production-recommendation>Production Recommendation <a href=#production-recommendation class=direct-link>#</a></h2><p>The <code>measureTime</code> utilities function is cool but still has some inconvenient when using in production. We might not only want to log the information but also want to save it into database or send it to some monitoring services. Hence we need a better helper utilities to serve those purposes. Luckily, building a helper in this case is very easy.<p>Let call a function or a block of code as an <code>execution context</code>, each execution context may have one or multiple steps - which we will call as a <code>span</code><strong>.</strong> The execution context would look like this**:**<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Oc2LR-1920w.avif 1920w, /img/remote/Oc2LR-1280w.avif 1280w, /img/remote/Oc2LR-640w.avif 640w, /img/remote/Oc2LR-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Oc2LR-1920w.webp 1920w, /img/remote/Oc2LR-1280w.webp 1280w, /img/remote/Oc2LR-640w.webp 640w, /img/remote/Oc2LR-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Oc2LR-1920w.jpg 1920w, /img/remote/Oc2LR-1280w.jpg 1280w, /img/remote/Oc2LR-640w.jpg 640w, /img/remote/Oc2LR-320w.jpg 320w" type=image/jpeg><img alt="Execution Context/Thanh Pham" decoding=async height=154 loading=lazy src=/img/remote/Oc2LR-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 320 154'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAxElEQVQImWN4vD5syusVJrtfrzDZ8maF+c7r862331hgs//6fOu9r1eab3mz0vT42+VGWx6t9Z/GcKW9ZM69svBD8f5GZm7G4obuxsKmbsbiRm4mogZuJsKGbiaiFq6mEibOpvKaDHWBAb4zExLTXVrzY6yqU6Ota9JiPTJijRlwAT4+Po7A9RM7XOY2dphMr+jImTQ1zVk/2MjZNNjIxTzIFIwt/bWxam5JWxS3IOHe1lkJ1zbPSri2ZWHi/Y2LCy5PAwCTuEus7B5h/AAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=320></picture><p>Execution Context/Thanh Pham<p>Base on the above execution flow, we can model information of a execution context as below:<pre class=language-go><code class=language-go><span class="token keyword">type</span> Record <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Context is name of the context.</span><br>	Context  <span class="token builtin">string</span>                   <span class="token string">`json:"context"`</span><br>    <span class="token comment">// Duration hold execution time of the whole context.</span><br>	Duration time<span class="token punctuation">.</span>Duration            <span class="token string">`json:"duration"`</span><br>    <span class="token comment">// Spans hold the execution time of each span in the context.</span><br>	Spans    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>Duration <span class="token string">`json:"spans"`</span><br>    <span class="token comment">// Meta hold metadata of the context for tracing purpose.</span><br>	Meta     <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token string">`json:"meta"`</span><br><span class="token punctuation">}</span></code></pre><p>Let call our helper as <code>TimeRecorder</code>. The <code>TimeRecorder</code>would need to serve for both consecutive or concurrent execution contextes. Hence it should look like:<pre class=language-go><code class=language-go><span class="token keyword">type</span> TimeRecorder <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token comment">// Done records the execution time of the given span since the last time Done was called.</span><br>	<span class="token comment">// Done updates the internal clock of the recorder.</span><br>	<span class="token function">Done</span><span class="token punctuation">(</span>span <span class="token builtin">string</span><span class="token punctuation">)</span><br><br>	<span class="token comment">// Last return the last recorded time of the internal clock of the recorder.</span><br>	<span class="token comment">// Last is normally used with DoneSince.</span><br>	<span class="token function">Last</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time<br>	<br>	<span class="token comment">// DoneSince records the execution time of the given span since the given time.</span><br>	<span class="token comment">// Note that DoneSince doesn't update the internal clock of the recorder.</span><br>	<span class="token comment">// Normally it is used in case there is a span run concurrently with the others.</span><br>	<span class="token function">DoneSince</span><span class="token punctuation">(</span>span <span class="token builtin">string</span><span class="token punctuation">,</span> t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span><br><br>	<span class="token comment">// Info return time execution info of the context and detail</span><br>	<span class="token comment">// of the recorded spans at the moment.</span><br>	<span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Record<br><span class="token punctuation">}</span></code></pre><p>A simple implementation of the <code>TimeRecorder</code>can be found in this <a href=https://github.com/pthethanh/micro/blob/master/util/timeutil/recorder.go>repo</a>.<p>By using the library above, our code in case of consecutive run would look much simpler:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	r <span class="token operator">:=</span> timeutil<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span><span class="token string">"doSomething"</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	r<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token string">"doStep1"</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	r<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token string">"doStep2"</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	r<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token string">"doStep3"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p><a href=https://play.golang.org/p/JN0decXRX_D>Playground</a><p>And in case of concurrency, the code would look much simpler too:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	r <span class="token operator">:=</span> timeutil<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span><span class="token string">"doSomething"</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	r<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token string">"doStep1"</span><span class="token punctuation">)</span><br><br>	last <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">doStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		r<span class="token punctuation">.</span><span class="token function">DoneSince</span><span class="token punctuation">(</span><span class="token string">"doStep2"</span><span class="token punctuation">,</span> last<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token function">doStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	r<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token string">"doStep3"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p><a href=https://play.golang.org/p/dM0T8_mGAZU>Playground</a><p>The result would look like:<pre class=language-go><code class=language-go>context<span class="token punctuation">:</span>doSomething<span class="token punctuation">,</span> duration<span class="token punctuation">:</span>4s<span class="token punctuation">,</span> spans<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span>doStep1<span class="token punctuation">:</span>1s doStep2<span class="token punctuation">:</span>2s doStep3<span class="token punctuation">:</span>3s<span class="token punctuation">]</span><span class="token punctuation">,</span> meta<span class="token punctuation">:</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><h2 id=summary>Summary <a href=#summary class=direct-link>#</a></h2><p>With just some very basic technique we are able build a very useful time measurement helper in Go. You can take this to further steps by integrate it into a middleware to measure performance of a REST API call or gRPC call.<p>For any discussion, please leave comments below.</p><share-widget><button aria-label=Share href=https://thefortunedays.com/articles/measure-execution-time/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Measure Execution Time","image":["https://thefortunedays.com/img/remote/vx8xA-1920w.jpg","https://thefortunedays.com/img/remote/10ttJe-1920w.jpg","https://thefortunedays.com/img/remote/ZDcrhv-1920w.jpg","https://thefortunedays.com/img/remote/Oc2LR-1920w.jpg"],"author":"Thanh","genre":"Blog","publisher":{"@type":"Organization","name":"Thanh","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=735479e2c4"}},"url":"https://thefortunedays.com/articles/measure-execution-time/","mainEntityOfPage":"https://thefortunedays.com/articles/measure-execution-time/","datePublished":"2021-04-19","dateModified":"2024-03-09","description":"Summary: Measuring time is a very important step to optimize performance or identify a performance issue. This article shows you how easy..."}</script></article></main><footer><a href=/about/ >Thanh</a></footer>