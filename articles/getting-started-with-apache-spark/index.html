<!DOCTYPE html><html domain=thefortunedays.com lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=/favicon.svg rel=icon type=image/svg+xml><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Getting Started With Apache Spark</title><meta content="Getting Started With Apache Spark" property=og:title><meta content="Getting started with Apache Spark and Structure Streaming on Kubernetes." name=description><meta content="Getting started with Apache Spark and Structure Streaming on Kubernetes." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@phamthethanh108 name=twitter:site><meta content=@phamthethanh108 name=twitter:creator><meta content=https://thefortunedays.com/img/remote/Z1o6V9l.jpg property=og:image><link href=https://thefortunedays.com/articles/getting-started-with-apache-spark/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="[ The Fortune Days ]"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4025327352745846" crossorigin=anonymous></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #0077ED;--primary-dark:#006EDB;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.375em 1.5em;background:#434344;font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#8dff80;z-index:1000}header aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:Inter UI,sans-serif;--font-family: Inter UI, sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h3{margin-bottom:1.36rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.6rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}h3{font-size:2.1989rem;line-height:2.64rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h3,p,pre,ul{margin-bottom:1.496rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h3{font-family:var(--font-family)}h2{font-style:italic}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:#111113;color:#f5f5f7}header{padding:4.5em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#ffff;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto}footer{background:#282829;color:#999;padding:3em;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.namespace{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>[ The Fortune Days ]</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><h1>Getting Started With Apache Spark</h1><aside>3 min read.</aside><dialog id=message></dialog></header><main><article><p><img alt="Introduction to Apache Spark" src=/img/remote/articles/getting-started-with-apache-spark/Spark.jpg><h2 id=prerequisite>Prerequisite <a href=#prerequisite class=direct-link>#</a></h2><ul><li>Docker<li>Minikube<li>Download and setup Spark on local machine for spark-submit<ul><li>Spark: spark-3.5.0-bin-hadoop3<li>Java: 17<li>Scala: 2.12<li>Set envs:<ul><li>export PATH=$PATH:/home/pthethanh/bin/spark-3.5.0-bin-hadoop3/bin<li>export SPARK_HOME=/home/pthethanh/bin/spark-3.5.0-bin-hadoop3<li>export HADOOP_HOME=/home/pthethanh/bin/spark-3.5.0-bin-hadoop3</ul></ul></ul><h2 id=spark-project>Spark Project <a href=#spark-project class=direct-link>#</a></h2><p>Main.scala<pre class=language-scala><code class=language-scala><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession<br><br><br><span class="token keyword">object</span> Main <span class="token punctuation">{</span><br>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token keyword">val</span> spark<span class="token operator">:</span>SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"hello-spark"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_<br>    <span class="token keyword">val</span> df <span class="token operator">=</span> spark<br>      <span class="token punctuation">.</span>readStream<br>      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"kafka"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"kafka.bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"kafka:9092"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"subscribe"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>option<span class="token punctuation">(</span> <span class="token string">"kafka.sasl.mechanism"</span><span class="token punctuation">,</span> <span class="token string">"PLAIN"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"kafka.security.protocol"</span> <span class="token punctuation">,</span> <span class="token string">"SASL_PLAINTEXT"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"kafka.sasl.jaas.config"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.security.plain.PlainLoginModule required username=\"user1\" password=\"lYG5y9Awl6\";"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">val</span> ds <span class="token operator">=</span> df<span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">"CAST(key AS STRING)"</span><span class="token punctuation">,</span> <span class="token string">"CAST(value AS STRING)"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br>    ds<span class="token punctuation">.</span>writeStream<br>      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"console"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"append"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>build.sbt<pre class=language-shell><code class=language-shell>ThisBuild / version :<span class="token operator">=</span> <span class="token string">"0.1.0-SNAPSHOT"</span><br><br>ThisBuild / scalaVersion :<span class="token operator">=</span> <span class="token string">"2.12.18"</span><br><br>libraryDependencies <span class="token operator">+=</span> <span class="token string">"org.apache.spark"</span> %% <span class="token string">"spark-core"</span> % <span class="token string">"3.5.0"</span><br>libraryDependencies <span class="token operator">+=</span> <span class="token string">"org.apache.spark"</span> %% <span class="token string">"spark-sql"</span> % <span class="token string">"3.5.0"</span><br>libraryDependencies <span class="token operator">+=</span> <span class="token string">"org.apache.spark"</span> %% <span class="token string">"spark-sql-kafka-0-10"</span> % <span class="token string">"3.5.0"</span> % Test<br><br>Compile / run / mainClass :<span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token string">"Main"</span><span class="token punctuation">)</span><br><br>lazy val root <span class="token operator">=</span> <span class="token punctuation">(</span>project <span class="token keyword">in</span> file<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">))</span><br>  .settings<span class="token punctuation">(</span><br>    name :<span class="token operator">=</span> <span class="token string">"hello-spark"</span><br>  <span class="token punctuation">)</span></code></pre><p>Dockerfile<pre class=language-dockerfile><code class=language-dockerfile><span class="token instruction"><span class="token keyword">ARG</span> SCALA_VERSION=2.12</span><br><span class="token instruction"><span class="token keyword">ARG</span> ARG_JAR_NAME=hello-spark_2.12-0.1.0-SNAPSHOT.jar</span><br><span class="token instruction"><span class="token keyword">ARG</span> ARG_MAIN_CLASS=Main</span><br><br><br><span class="token instruction"><span class="token keyword">FROM</span> sbtscala/scala-sbt:graalvm-ce-22.3.3-b1-java17_1.9.9_2.12.18 <span class="token keyword">as</span> build</span><br><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span><br><span class="token instruction"><span class="token keyword">COPY</span> . .</span><br><span class="token instruction"><span class="token keyword">RUN</span> sbt package</span><br><br><span class="token instruction"><span class="token keyword">FROM</span> spark:registry</span><br><span class="token instruction"><span class="token keyword">ARG</span> ARG_JAR_NAME</span><br><span class="token instruction"><span class="token keyword">ARG</span> ARG_MAIN_CLASS</span><br><span class="token instruction"><span class="token keyword">ARG</span> SCALA_VERSION</span><br><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/target/scala-<span class="token variable">${SCALA_VERSION}</span>/<span class="token variable">${ARG_JAR_NAME}</span> /opt/bitnami/spark/work/application.jar</span><br></code></pre><h2 id=deployment>Deployment <a href=#deployment class=direct-link>#</a></h2><h3 id=deploy-kafka>Deploy Kafka <a href=#deploy-kafka class=direct-link>#</a></h3><p>Get user/pass of Kafka<pre class=language-shell><code class=language-shell>kubectl <span class="token builtin class-name">exec</span> kafka-controller-0 -- <span class="token function">cat</span> /opt/bitnami/kafka/config/server.properties</code></pre><p>Run kafka-client<pre class=language-shell><code class=language-shell>kubectl run kafka-client --rm -ti --image bitnami/kafka:3.6.1-debian-12-r12 -- <span class="token function">bash</span><br><span class="token builtin class-name">cd</span> /opt/bitnami/kafka/bin<br><br><span class="token function">cat</span> <span class="token operator">>></span> pthethanh.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF<br>security.protocol=SASL_PLAINTEXT<br>sasl.mechanism=PLAIN<br>sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="user1" password="kk3gaqZRly";<br>EOF</span><br><br>kafka-topics.sh --create --topic <span class="token builtin class-name">test</span> --bootstrap-server kafka:9092 --command-config pthethanh.conf<br><br>kafka-console-producer.sh --topic <span class="token builtin class-name">test</span> --request-required-acks all --bootstrap-server kafka:9092 --producer.config pthethanh.conf<br><br>kafka-console-consumer.sh --topic <span class="token builtin class-name">test</span> --bootstrap-server kafka:9092 --consumer.config pthethanh.conf<br></code></pre><h3 id=deploy-spark-application>Deploy Spark Application <a href=#deploy-spark-application class=direct-link>#</a></h3><p>Prepare spark driver base image:<pre class=language-shell><code class=language-shell><span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>minikube -p minikube docker-env<span class="token variable">)</span></span><br>docker-image-tool.sh -t registry build</code></pre><p>Build Spark application Docker image<pre class=language-shell><code class=language-shell><span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>minikube -p minikube docker-env<span class="token variable">)</span></span><br><span class="token function">docker</span> build -t hello-spark:latest <span class="token builtin class-name">.</span></code></pre><p>Create service account<pre class=language-shell><code class=language-shell>kubectl create serviceaccount sparksubmit<br>kubectl create clusterrolebinding sparksubmit-role --clusterrole<span class="token operator">=</span>edit --serviceaccount<span class="token operator">=</span>default:sparksubmit --namespace<span class="token operator">=</span>default</code></pre><p>Get cluster info<pre class=language-shell><code class=language-shell>kubectl cluster-info</code></pre><p>Submit spark application<pre class=language-shell><code class=language-shell>spark-submit <span class="token punctuation">\</span><br>--master k8s://https://127.0.0.1:32769 <span class="token punctuation">\</span><br>--deploy-mode cluster <span class="token punctuation">\</span><br>--name hello-spark <span class="token punctuation">\</span><br>--class Main <span class="token punctuation">\</span><br>--conf spark.kubernetes.namespace<span class="token operator">=</span>default <span class="token punctuation">\</span><br>--conf spark.kubernetes.container.image<span class="token operator">=</span>hello-spark:latest <span class="token punctuation">\</span><br>--packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.1 <span class="token punctuation">\</span><br>--conf spark.driver.extraJavaOptions<span class="token operator">=</span><span class="token string">"-Divy.cache.dir=/tmp -Divy.home=/tmp"</span> <span class="token punctuation">\</span><br>--conf spark.kubernetes.authenticate.driver.serviceAccountName<span class="token operator">=</span>sparksubmit <span class="token punctuation">\</span><br>--conf spark.kubernetes.authenticate.submission.caCertFile<span class="token operator">=</span>/home/pthethanh/.minikube/ca.crt <span class="token punctuation">\</span><br>local:///app/work/application.jar</code></pre><p>Expose the Spark driver UI<pre class=language-shell><code class=language-shell>kubectl port-forward hello-spark-4586aa8e0dd8e8fe-driver <span class="token number">4040</span>:4040</code></pre><p>Check logs of the driver<pre class=language-shell><code class=language-shell>kubectl logs hello-spark-4586aa8e0dd8e8fe-driver -f</code></pre><p>Send some messages to Kafka topic test<pre class=language-shell><code class=language-shell>kafka-console-producer.sh --topic <span class="token builtin class-name">test</span> --request-required-acks all --bootstrap-server kafka:9092 --producer.config pthethanh.conf</code></pre><p>Kill the spark application<pre class=language-shell><code class=language-shell>spark-submit --kill hello-spark-d5358c8e1cd2e8b0-driver --master k8s://https://127.0.0.1:32769</code></pre><share-widget><button aria-label=Share href=https://thefortunedays.com/articles/getting-started-with-apache-spark/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Getting Started With Apache Spark","image":["https://thefortunedays.com/img/remote/articles/getting-started-with-apache-spark/Spark.jpg"],"author":"Thanh Pham","genre":"Blog","publisher":{"@type":"Organization","name":"Thanh Pham","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=735479e2c4"}},"url":"https://thefortunedays.com/articles/getting-started-with-apache-spark/","mainEntityOfPage":"https://thefortunedays.com/articles/getting-started-with-apache-spark/","datePublished":"2024-03-07","dateModified":"2024-03-09","description":"Prerequisite # Docker Minikube Download and setup Spark on local machine for spark-submit Spark: spark-3.5.0-bin-hadoop3 Java: 17 Scala:..."}</script></article></main><footer><a href=/about/ >Thanh Pham</a></footer>