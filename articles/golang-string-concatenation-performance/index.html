<!DOCTYPE html><html domain=thefortunedays.com lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=735479e2c4" rel=icon type=image/png><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Go String Concat Performance</title><meta content="Go String Concat Performance" property=og:title><meta content="String contact performance in Go." name=description><meta content="String contact performance in Go." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@phamthethanh108 name=twitter:site><meta content=@phamthethanh108 name=twitter:creator><meta content=https://thefortunedays.com/img/remote/Z1o6V9l.jpg property=og:image><link href=https://thefortunedays.com/articles/golang-string-concatenation-performance/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="The Fortune Days"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/CyberwayRiders.woff2 rel=preload type=font/woff2 as=font crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4025327352745846" crossorigin=anonymous></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #ff577d;--primary-dark:#ff184c;--text-color: #F5F5F7;--bg-color: 	#003062;--nav-bg-color: #ff577d;--nav-text-color: #fff;--footer-bg-color: #091833;--footer-text-color: #999;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.575em 1.5em;background:var(--nav-bg-color);color:var(--nav-text-color);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#0a9cf5;z-index:1000}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"CyberwayRiders";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/CyberwayRiders.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Inter UI",sans-serif;--font-family: "Inter UI", sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}small{font-size:80%;color:#ccc}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem;margin-bottom:1.36rem}h2{font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,p,pre,ul{margin-bottom:1.496rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2{font-family:var(--font-family)}h2{font-style:italic}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:var(--bg-color);color:var(--text-color)}header{padding:4em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:var(--nav-text-color);margin-left:1.5em;font-family:'CyberwayRiders'}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto}footer{background:var(--footer-bg-color);color:var(--footer-text-color);padding:3em;text-align:center}footer>*{margin:1.5em;font-family:'CyberwayRiders'}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}.about{min-height:63vh}.about h1{font-family:'CyberwayRiders';padding-bottom:1em}.tags h1,article aside,article h1{text-align:center}article aside{font-style:italic;padding-bottom:4.25em}.tags{min-height:68vh}.tags h1{font-family:'CyberwayRiders';padding-bottom:1em}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>The Fortune Days</a></h1><a href=/tags/ >Tags</a> <a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><dialog id=message></dialog></header><main><article><h1>Go String Concat Performance</h1><aside>8 min read.</aside><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1dsVUd-1920w.avif 1920w, /img/remote/1dsVUd-1280w.avif 1280w, /img/remote/1dsVUd-640w.avif 640w, /img/remote/1dsVUd-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1dsVUd-1920w.webp 1920w, /img/remote/1dsVUd-1280w.webp 1280w, /img/remote/1dsVUd-640w.webp 640w, /img/remote/1dsVUd-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1dsVUd-1920w.jpg 1920w, /img/remote/1dsVUd-1280w.jpg 1280w, /img/remote/1dsVUd-640w.jpg 640w, /img/remote/1dsVUd-320w.jpg 320w" type=image/jpeg><img alt="Go string concatenation performance comparison" decoding=async height=507 loading=lazy src=/img/remote/1dsVUd-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 733 507'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAYUlEQVQImV2MSw7DIBDFuP8tA5uAhgXzEN8HqRpVUVRvbdkAGGNcL0iOOUkaAGutvTeA8/QhhChSSqm1GhEh6Zyz1gJQ1WdjjpsYY2vtff46772q4iallHMm+XN/be/9cR8myJxoy7fheQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=733></picture><p><strong>Summary</strong>: strings.Builder gives very good performance in general, but we can improve it even better.<p>Go string concatenation performance comparison<p>String concatenation is a basic task that I often do as a developer, but I have never considered much about its performance. This article is a result of my curiosity about this topic.<h2 id=navie>Navie <a href=#navie class=direct-link>#</a></h2><p>The very normal approach that I often took when I first started with Go was to use a naive concatenation like this:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">concatNaive</span><span class="token punctuation">(</span>ss <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	rs <span class="token operator">:=</span> ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		rs <span class="token operator">+=</span> ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// cause memory allocation</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> rs<br><span class="token punctuation">}</span></code></pre><p>But this approach gives the worst performance. The statement <code>rs += ss[i]</code> will allocate new memory each time it is called. And we all know that allocation reduces the performance of function calls. Hence, we have to avoid it as much as we can.<p>The simple way to avoid multiple allocations is to allocate them in advance and make sure we allocate enough memory to avoid any additional allocations during the function calls. I came up with another brilliant idea, where I allocate the memory in advance and assign it byte by byte:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">concatAssignIndex</span><span class="token punctuation">(</span>ss <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	length <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token string">""</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// create & allocate the memory in advance.</span><br>	n <span class="token operator">:=</span> <span class="token number">0</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		n <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> n<span class="token punctuation">)</span><br>	idx <span class="token operator">:=</span> <span class="token number">0</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span><br>			b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><br>			idx<span class="token operator">++</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>I thought it should be great, but this turns out to be another naive solution. You can see the nested loops that cause the big performance issue in the above block of code.<p>So, I gave up and tried one of the solutions recommended by most people in the community, <code>strings.Builder</code>.<h2 id=string-builder>String Builder <a href=#string-builder class=direct-link>#</a></h2><p><code>strings.Builder</code> maintains an underlying byte buffer and exposes the <code>Grow(int)</code> method so that we can use it to grow the underlying buffer. The code using the string builder will look like this:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">concatStringBuilder</span><span class="token punctuation">(</span>ss <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	length <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token string">""</span><br>	<span class="token punctuation">}</span><br>	b <span class="token operator">:=</span> strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span><br>	<span class="token comment">// calculate the buffer size</span><br>	n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		n <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// grow the buffer to avoid memory allocation during writing new string.</span><br>	b<span class="token punctuation">.</span><span class="token function">Grow</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>Based on my testing, the <code>strings.Builder</code> gives very good performance and should be used in general cases. But one thing to notice when using strings.Builder is that you have to calculate the buffer size and grow it accordingly. Otherwise, the buffer will need to grow more and more during the function call, which will slow it down.<p>I doubt if it's true that strings.Builder is the best one. I think we can improve it even further. Let's see how strings.Builder is implemented.<h2 id=improved-string-builder>Improved String Builder <a href=#improved-string-builder class=direct-link>#</a></h2><p>If we look at the <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.20.3:src/strings/builder.go;l=76-92">implementation</a> of the strings.Builder, we can see that it maintains a slice of bytes, using <code>make</code> with capacity to allocate memory in advance and <code>append</code> to append the string to the buffer:<pre class=language-go><code class=language-go><span class="token comment">// grow copies the buffer to a new, larger buffer so that there are at least n</span><br><span class="token comment">// bytes of capacity beyond len(b.buf).</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">grow</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span><span class="token function">cap</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token operator">+</span>n<span class="token punctuation">)</span><br>	<span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> b<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><br>	b<span class="token punctuation">.</span>buf <span class="token operator">=</span> buf<br><span class="token punctuation">}</span><br><br><span class="token comment">// WriteString appends the contents of s to b's buffer.</span><br><span class="token comment">// It returns the length of s and a nil error.</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">WriteString</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	b<span class="token punctuation">.</span><span class="token function">copyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	b<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> s<span class="token operator">...</span><span class="token punctuation">)</span><br>	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p>This piece of code looks so good, and we can learn from it to make our own version. In our case, we don't really need <code>b.copyCheck()</code> as we have a function instead of a method of a struct. We can eliminate this check and have a simple function like the one below, similar to what the strings.Builder tries to do:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">concatFast</span><span class="token punctuation">(</span>ss <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	length <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token string">""</span><br>	<span class="token punctuation">}</span><br>	n <span class="token operator">:=</span> <span class="token number">0</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		n <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// create & allocate the memory in advance.</span><br>	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// below statement causes a memory allocation.</span><br>	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>The above function looks good, as we calculated and allocated the buffer to the exact size of the output string, but there's still a problem. The last statement, <code>string(b)</code> causes a memory allocation and hence reduces the performance of the function call. Let's see the benchmark below, the concatFast has 2 allocations instead of 1, and its performance is slower than the strings.Builder:<pre class=language-bash><code class=language-bash>goos: windows<br>goarch: amd64<br>pkg: github.com<br>cpu: 12th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-1255U<br>BenchmarkSmall/concat_fast_using_append__________-12             <span class="token number">8743449</span>               <span class="token number">148.8</span> ns/op           <span class="token number">576</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkSmall/concat_string_builder_____________-12            <span class="token number">12188716</span>                <span class="token number">95.24</span> ns/op          <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op</code></pre><p>Is there any way to avoid that allocation? You might wonder! Yes, there is a way to avoid that allocation by using <code>unsafe</code> package, and this is exactly the way strings.Builder does:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">SliceData</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>This hack is pretty cool, and we can apply it to our function, the improved version would look like this:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">concatFastImproved</span><span class="token punctuation">(</span>ss <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>	length <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token string">""</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// create & allocate the memory in advance.</span><br>	n <span class="token operator">:=</span> <span class="token number">0</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		n <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">SliceData</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>The above method looks pretty good and gives better performance compared to strings.Builder. An alternative to <code>append</code> is <code>copy</code>, and it would give a similar performance. Up to now, this has been the fastest solution so far.<p>One lesson I learn from this is that it's always a good idea to use built-in functions like <code>copy</code> and <code>append</code> as much as we can. And by talking about built-in, I wonder if the solution of using the concatenation operator would give a similar performance.<h2 id=%2B-operator>+ Operator <a href=#%2B-operator class=direct-link>#</a></h2><p>This is one of the simplest solutions ever. Just do <code>s[0] + s[2] + s[3]+ ... + s[n]</code> and we can have what we want. This solution gives a very good performance, which is similar to our improved version of strings.Builder.<p>I think the reason is because the way Go runtime also uses <code>copy</code> in its <a href=https://go.dev/src/runtime/string.go#L20>implementation</a>, but it seems its optimization is just for strings with length &lt;= <a href=https://go.dev/src/runtime/string.go#L14>32</a>, so if our string is longer than that, the optimization seems not to be applied.<p>But notice that the challenge when you want to use this approach is that you have to know the length of the slice in advance. I think usage of this is limited.<h2 id=other-solutions%3F>Other solutions? <a href=#other-solutions%3F class=direct-link>#</a></h2><p>Other solutions, including <code>fmt.Sprintf</code> or using <code>bytes.Buffer</code> give much worse performance than our improved version of string builder. But maybe there are still a lot of other solutions that I don't know yet.<h2 id=the-code-and-the-benchmark>The code and the benchmark <a href=#the-code-and-the-benchmark class=direct-link>#</a></h2><p>I tested all the approaches with small, medium, and big slices with lengths of 10, 100, and 10,000 respectively to see the differences, and the winner is our improved version of strings.Builder.<p>You can see the code here in the <a href=https://gist.github.com/pthethanh/e7624f54d98633c3e7f0c71415a253b1>gist</a>. And below is the benchmark:<pre class=language-bash><code class=language-bash>goos: windows<br>goarch: amd64<br>pkg: github.com<br>cpu: 12th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-1255U<br>BenchmarkSmall/concat_naive______________________-12             <span class="token number">2725071</span>               <span class="token number">449.6</span> ns/op          <span class="token number">1520</span> B/op          <span class="token number">9</span> allocs/op<br>BenchmarkSmall/concat_string_builder_without_grow-12             <span class="token number">3993370</span>               <span class="token number">287.7</span> ns/op           <span class="token number">984</span> B/op          <span class="token number">5</span> allocs/op<br>BenchmarkSmall/concat_assign_index_______________-12             <span class="token number">4681068</span>               <span class="token number">255.5</span> ns/op           <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkSmall/concat_bytes_buffer_______________-12             <span class="token number">6646387</span>               <span class="token number">179.3</span> ns/op           <span class="token number">576</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkSmall/concat_fast_using_append__________-12             <span class="token number">8743449</span>               <span class="token number">148.8</span> ns/op           <span class="token number">576</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkSmall/concat_string_builder_____________-12            <span class="token number">12188716</span>                <span class="token number">95.24</span> ns/op          <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkSmall/concat_+_operator_________________-12            <span class="token number">11912088</span>                <span class="token number">96.59</span> ns/op          <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkSmall/concat_fast_improved______________-12            <span class="token number">13002703</span>                <span class="token number">90.33</span> ns/op          <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkSmall/concat_fast_improved_using_copy___-12            <span class="token number">14131878</span>                <span class="token number">97.54</span> ns/op          <span class="token number">288</span> B/op          <span class="token number">1</span> allocs/op<br><br>BenchmarkMedium/concat_naive______________________-12              <span class="token number">14560</span>             <span class="token number">82115</span> ns/op          <span class="token number">509697</span> B/op         <span class="token number">98</span> allocs/op<br>BenchmarkMedium/concat_string_builder_without_grow-12             <span class="token number">172482</span>              <span class="token number">5974</span> ns/op           <span class="token number">34240</span> B/op         <span class="token number">12</span> allocs/op<br>BenchmarkMedium/concat_assign_index_______________-12             <span class="token number">130524</span>              <span class="token number">8269</span> ns/op            <span class="token number">9472</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkMedium/concat_bytes_buffer_______________-12             <span class="token number">447615</span>              <span class="token number">2940</span> ns/op           <span class="token number">18944</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkMedium/concat_fast_using_append__________-12             <span class="token number">376473</span>              <span class="token number">2819</span> ns/op           <span class="token number">18944</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkMedium/concat_string_builder_____________-12             <span class="token number">655304</span>              <span class="token number">1619</span> ns/op            <span class="token number">9472</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkMedium/concat_+_operator_________________-12             <span class="token number">746950</span>              <span class="token number">1637</span> ns/op            <span class="token number">9472</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkMedium/concat_fast_improved______________-12             <span class="token number">749499</span>              <span class="token number">1613</span> ns/op            <span class="token number">9472</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkMedium/concat_fast_improved_using_copy___-12             <span class="token number">864777</span>              <span class="token number">1623</span> ns/op            <span class="token number">9472</span> B/op          <span class="token number">1</span> allocs/op<br><br>BenchmarkBig/concat_naive______________________-12                     <span class="token number">2</span>         <span class="token number">745434800</span> ns/op        <span class="token number">4995658496</span> B/op    <span class="token number">10072</span> allocs/op<br>BenchmarkBig/concat_string_builder_without_grow-12                  <span class="token number">1558</span>            <span class="token number">901401</span> ns/op         <span class="token number">5241548</span> B/op         <span class="token number">30</span> allocs/op<br>BenchmarkBig/concat_assign_index_______________-12                  <span class="token number">1155</span>            <span class="token number">941113</span> ns/op          <span class="token number">999430</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkBig/concat_bytes_buffer_______________-12                  <span class="token number">2985</span>            <span class="token number">438088</span> ns/op         <span class="token number">1998854</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkBig/concat_fast_using_append__________-12                  <span class="token number">2904</span>            <span class="token number">444509</span> ns/op         <span class="token number">1998854</span> B/op          <span class="token number">2</span> allocs/op<br>BenchmarkBig/concat_string_builder_____________-12                  <span class="token number">4792</span>            <span class="token number">245516</span> ns/op          <span class="token number">999429</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkBig/concat_fast_improved______________-12                  <span class="token number">4142</span>            <span class="token number">242516</span> ns/op          <span class="token number">999429</span> B/op          <span class="token number">1</span> allocs/op<br>BenchmarkBig/concat_fast_improved_using_copy___-12                  <span class="token number">4478</span>            <span class="token number">260349</span> ns/op          <span class="token number">999430</span> B/op          <span class="token number">1</span> allocs/op<br>PASS<br>ok      github.com        <span class="token number">39</span>.751s</code></pre><h2 id=lessons-learn>Lessons Learn <a href=#lessons-learn class=direct-link>#</a></h2><p>I think there are a couple of things we can learn from this:<ul><li>Avoid memory allocation as much as we can.<li>Whenever a slice is used, try to allocate enough memory for it in advance.<li>Take advantage of built-in functions like <code>append</code>, <code>copy</code>,...<li>Sometimes <code>unsafe</code> package can provide some pretty good hacks for better performance, but they should be used with care.<li>Try to run benchmarks with multiple cases, small, medium, and large inputs to see the differences and improve the code from there.<li>There are a lot of things we can learn from the Go SDK, like strings.Builder in this case.<li>Explore the SDK code is a good way to learn and be a better Gopher.</ul><share-widget><button aria-label=Share href=https://thefortunedays.com/articles/golang-string-concatenation-performance/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Go String Concat Performance","image":["https://thefortunedays.com/img/remote/1dsVUd-1920w.jpg"],"author":"Thanh Pham","genre":"Blog","publisher":{"@type":"Organization","name":"Thanh Pham","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=735479e2c4"}},"url":"https://thefortunedays.com/articles/golang-string-concatenation-performance/","mainEntityOfPage":"https://thefortunedays.com/articles/golang-string-concatenation-performance/","datePublished":"2023-04-10","dateModified":"2024-03-09","description":"Summary: strings.Builder gives very good performance in general, but we can improve it even better. Go string concatenation performance..."}</script></article></main><footer><a href=/about/ >Thanh Pham</a></footer>